# apiVersion: v1
# kind: Secret
# metadata:
#   name: dozzle-auth
#   namespace: terotam
# type: Opaque
# stringData:
#   users: |
#     admin:astics123
#     mayur:mysecurepassword
# Secret with users
apiVersion: v1
kind: Secret
metadata:
  name: dozzle-auth
  namespace: terotam
type: Opaque
stringData:
  users.yml: |
    users:
      admin:
        email: admin@example.com
        name: Admin
        password: "$2a$11$XS9YbWbKu/tDX9tB5pNmfuAKp0yKS4/YfbirXQaXYHukhGdKg1rwe" #astics123
        filter:
      mayur:
        email: mayur@example.com
        name: Mayur
        password: "mysecurepassword"
        filter:
---
# rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pod-viewer
  namespace: terotam
---
# clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pod-viewer-role
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log", "nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods"]
    verbs: ["get", "list"]
---
# clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pod-viewer-binding
subjects:
  - kind: ServiceAccount
    name: pod-viewer
    namespace: terotam
roleRef:
  kind: ClusterRole
  name: pod-viewer-role
  apiGroup: rbac.authorization.k8s.io
---
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dozzle
  namespace: terotam
spec:
  selector:
    matchLabels:
      app: dozzle
  template:
    metadata:
      labels:
        app: dozzle
        environment: sandbox
    spec:
      serviceAccountName: pod-viewer
      containers:
        - name: dozzle
          image: amir20/dozzle:latest
          ports:
            - containerPort: 8080
          env:
            - name: DOZZLE_MODE
              value: "k8s"
            - name: DOZZLE_AUTH_PROVIDER
              value: "simple"
            - name: DOZZLE_AUTH_TTL
              value: "10h"
            - name: DOZZLE_ENABLE_ACTIONS
              value: "true"
            - name: DOZZLE_ENABLE_SHELL
              value: "true"
          volumeMounts:
            - name: users-file
              mountPath: /data/users.yml
              subPath: users.yml
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
    volumes:
        - name: users-file
          secret:
            secretName: dozzle-auth
            items:
              - key: users.yml
                path: users.yml
---
# service.yaml
apiVersion: v1
kind: Service
metadata:
  name: dozzle
  namespace: terotam
spec:
  type: ClusterIP
  selector:
    app: dozzle
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP






# kubectl create secret generic dozzle-users \
#   --from-file=users.yml=users.yml \
#   -n youtube


# users:
#     admin:
#         email: ""
#         name: ""
#         password: $2a$11$XS9YbWbKu/tDX9tB5pNmfuAKp0yKS4/YfbirXQaXYHukhGdKg1rwe
#         filter: ""

#docker run --rm amir20/dozzle dozzle generate astics123


# #kubectl create secret generic dozzle-users \
#   --from-file=users.yml \
#   -n logging


